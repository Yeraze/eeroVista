{% extends "base.html" %}

{% block title %}Devices - eeroVista{% endblock %}

{% block extra_css %}
<style>
    .device-row {
        transition: opacity 0.2s;
    }
    .device-row.offline {
        opacity: 0.5;
    }
    .sortable-header {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px;
    }
    .sortable-header:hover {
        background-color: var(--surface0);
    }
    .sortable-header::after {
        content: '⇅';
        position: absolute;
        right: 5px;
        opacity: 0.3;
    }
    .sortable-header.sort-asc::after {
        content: '↑';
        opacity: 1;
    }
    .sortable-header.sort-desc::after {
        content: '↓';
        opacity: 1;
    }
    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    .status-online {
        background-color: var(--green);
        color: white;
    }
    .status-offline {
        background-color: var(--surface1);
        color: var(--subtext0);
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mt-4 mb-4">Connected Devices</h1>

<div class="card">
    <div class="card-title">Device List (<span id="device-count">0</span> devices)</div>
    <p class="text-muted">Click column headers to sort. Offline devices are dimmed.</p>

    <div class="mt-3" style="overflow-x: auto;">
        <table class="table">
            <thead>
                <tr>
                    <th class="sortable-header" data-column="name">Device Name</th>
                    <th class="sortable-header" data-column="type">Type</th>
                    <th class="sortable-header" data-column="ip_address">IP Address</th>
                    <th class="sortable-header" data-column="is_online">Status</th>
                    <th class="sortable-header" data-column="connection_type">Connection</th>
                    <th class="sortable-header" data-column="node">Node</th>
                </tr>
            </thead>
            <tbody id="devices-table-body">
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        Loading devices...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    let devicesData = [];
    let currentSort = { column: 'name', direction: 'asc' };

    // Fetch devices from API
    async function loadDevices() {
        try {
            const response = await fetch('/api/devices');
            const data = await response.json();

            devicesData = data.devices || [];
            document.getElementById('device-count').textContent = devicesData.length;

            renderDevices();
        } catch (error) {
            console.error('Failed to load devices:', error);
            document.getElementById('devices-table-body').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        Error loading devices. Please try refreshing the page.
                    </td>
                </tr>
            `;
        }
    }

    // Sort devices
    function sortDevices(column) {
        if (currentSort.column === column) {
            // Toggle direction
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
        }

        devicesData.sort((a, b) => {
            let aVal = a[column];
            let bVal = b[column];

            // Handle null/undefined
            if (aVal == null) aVal = '';
            if (bVal == null) bVal = '';

            // Convert to lowercase for string comparison
            if (typeof aVal === 'string') aVal = aVal.toLowerCase();
            if (typeof bVal === 'string') bVal = bVal.toLowerCase();

            if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
            return 0;
        });

        renderDevices();
        updateSortIndicators();
    }

    // Update sort indicators
    function updateSortIndicators() {
        document.querySelectorAll('.sortable-header').forEach(header => {
            header.classList.remove('sort-asc', 'sort-desc');
            if (header.dataset.column === currentSort.column) {
                header.classList.add(`sort-${currentSort.direction}`);
            }
        });
    }

    // Render devices table
    function renderDevices() {
        const tbody = document.getElementById('devices-table-body');

        if (devicesData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        No devices found
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = devicesData.map(device => {
            const rowClass = device.is_online ? '' : 'offline';
            const statusBadge = device.is_online
                ? '<span class="status-badge status-online">Online</span>'
                : '<span class="status-badge status-offline">Offline</span>';

            return `
                <tr class="device-row ${rowClass}">
                    <td>${device.name}</td>
                    <td>${device.type}</td>
                    <td>${device.ip_address}</td>
                    <td>${statusBadge}</td>
                    <td>${device.connection_type}</td>
                    <td>${device.node}</td>
                </tr>
            `;
        }).join('');
    }

    // Add click handlers to sortable headers
    document.querySelectorAll('.sortable-header').forEach(header => {
        header.addEventListener('click', () => {
            sortDevices(header.dataset.column);
        });
    });

    // Initial load
    loadDevices();

    // Refresh every 30 seconds
    setInterval(loadDevices, 30000);
</script>
{% endblock %}
