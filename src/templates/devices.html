{% extends "base.html" %}

{% block title %}Devices - eeroVista{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
{% endblock %}

{% block extra_css %}
<style>
    .device-row {
        transition: opacity 0.2s;
    }
    .device-row.offline {
        opacity: 0.5;
    }
    .sortable-header {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px;
    }
    .sortable-header:hover {
        background-color: var(--surface0);
    }
    .sortable-header::after {
        content: '⇅';
        position: absolute;
        right: 5px;
        opacity: 0.3;
    }
    .sortable-header.sort-asc::after {
        content: '↑';
        opacity: 1;
    }
    .sortable-header.sort-desc::after {
        content: '↓';
        opacity: 1;
    }
    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    .status-online {
        background-color: var(--green);
        color: white;
    }
    .status-offline {
        background-color: var(--surface1);
        color: var(--subtext0);
    }

    /* Make rows clickable */
    .device-row {
        cursor: pointer;
    }
    .device-row:hover {
        background-color: var(--surface0);
    }

    /* Modal styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background-color: var(--base);
        border: 2px solid var(--surface0);
        border-radius: 12px;
        padding: 1.5rem;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--surface0);
    }

    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text);
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--subtext0);
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
    }

    .modal-close:hover {
        background-color: var(--surface0);
        color: var(--text);
    }

    .modal-body {
        color: var(--text);
    }

    .info-row {
        display: flex;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--surface0);
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-label {
        font-weight: 600;
        color: var(--subtext1);
        min-width: 140px;
    }

    .info-value {
        color: var(--text);
        word-break: break-word;
    }

    .aliases-section {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 2px solid var(--surface0);
    }

    .aliases-label {
        font-weight: 600;
        color: var(--subtext1);
        margin-bottom: 0.5rem;
    }

    .aliases-textarea {
        width: 100%;
        min-height: 100px;
        padding: 0.5rem;
        background-color: var(--mantle);
        color: var(--text);
        border: 1px solid var(--surface0);
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.875rem;
        resize: vertical;
    }

    .aliases-textarea:focus {
        outline: none;
        border-color: var(--blue);
    }

    .aliases-help {
        font-size: 0.75rem;
        color: var(--subtext0);
        margin-top: 0.25rem;
    }

    .save-button {
        margin-top: 0.75rem;
        padding: 0.5rem 1rem;
        background-color: var(--blue);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
    }

    .save-button:hover {
        background-color: var(--sapphire);
    }

    .save-button:disabled {
        background-color: var(--surface1);
        color: var(--subtext0);
        cursor: not-allowed;
    }

    .save-message {
        display: none;
        margin-top: 0.5rem;
        padding: 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
    }

    .save-message.success {
        display: block;
        background-color: var(--green);
        color: white;
    }

    .save-message.error {
        display: block;
        background-color: var(--red);
        color: white;
    }

    /* Bandwidth graph styles */
    .bandwidth-section {
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 2px solid var(--surface0);
    }

    .bandwidth-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .bandwidth-title {
        font-weight: 600;
        color: var(--text);
        font-size: 1.1rem;
    }

    .interval-selector {
        display: flex;
        gap: 0.5rem;
    }

    .interval-btn {
        padding: 0.25rem 0.75rem;
        background-color: var(--surface0);
        color: var(--text);
        border: 1px solid var(--surface1);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .interval-btn.active {
        background-color: var(--blue);
        color: white;
        border-color: var(--blue);
    }

    .interval-btn:hover:not(.active) {
        background-color: var(--surface1);
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mt-4 mb-4">Connected Devices</h1>

<div class="card">
    <div class="card-title">Device List (<span id="device-count">0</span> devices, <span id="visible-count">0</span> shown)</div>
    <p class="text-muted">Click column headers to sort. Click on a device row to view details.</p>

    <!-- Filter controls -->
    <div style="display: flex; gap: 1rem; align-items: center; margin: 1rem 0; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
            <input
                type="text"
                id="filter-input"
                placeholder="Filter devices by name, IP, or type..."
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--surface1); border-radius: 4px; background: var(--base); color: var(--text);"
            />
        </div>
        <div>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; user-select: none;">
                <input
                    type="checkbox"
                    id="show-offline-checkbox"
                    checked
                    style="width: 18px; height: 18px; cursor: pointer;"
                />
                <span>Show Offline Devices</span>
            </label>
        </div>
    </div>

    <div class="mt-3" style="overflow-x: auto;">
        <table class="table">
            <thead>
                <tr>
                    <th class="sortable-header" data-column="name">Device Name</th>
                    <th class="sortable-header" data-column="type">Type</th>
                    <th class="sortable-header" data-column="ip_address">IP Address</th>
                    <th class="sortable-header" data-column="is_online">Status</th>
                    <th class="sortable-header" data-column="connection_type">Connection</th>
                    <th class="sortable-header" data-column="node">Node</th>
                </tr>
            </thead>
            <tbody id="devices-table-body">
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        Loading devices...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Device Details Modal -->
<div id="device-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title">Device Details</h2>
            <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body" id="modal-body">
            <!-- Content will be populated dynamically -->
        </div>
    </div>
</div>

<script>
    let devicesData = [];
    let currentSort = { column: 'name', direction: 'asc' };
    let filterText = '';
    let showOffline = true;

    // Fetch devices from API
    async function loadDevices() {
        try {
            const response = await fetch('/api/devices');
            const data = await response.json();

            devicesData = data.devices || [];
            document.getElementById('device-count').textContent = devicesData.length;

            // Re-apply current sort if one is active
            if (currentSort.column) {
                applySortWithoutToggle();
            } else {
                renderDevices();
            }
        } catch (error) {
            console.error('Failed to load devices:', error);
            document.getElementById('devices-table-body').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        Error loading devices. Please try refreshing the page.
                    </td>
                </tr>
            `;
        }
    }

    // Sort devices
    function sortDevices(column) {
        if (currentSort.column === column) {
            // Toggle direction
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
        }

        applySortWithoutToggle();
    }

    // Apply current sort without toggling direction
    function applySortWithoutToggle() {
        const column = currentSort.column;

        devicesData.sort((a, b) => {
            let aVal = a[column];
            let bVal = b[column];

            // Handle null/undefined
            if (aVal == null) aVal = '';
            if (bVal == null) bVal = '';

            // Convert to lowercase for string comparison
            if (typeof aVal === 'string') aVal = aVal.toLowerCase();
            if (typeof bVal === 'string') bVal = bVal.toLowerCase();

            if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
            return 0;
        });

        renderDevices();
        updateSortIndicators();
    }

    // Update sort indicators
    function updateSortIndicators() {
        document.querySelectorAll('.sortable-header').forEach(header => {
            header.classList.remove('sort-asc', 'sort-desc');
            if (header.dataset.column === currentSort.column) {
                header.classList.add(`sort-${currentSort.direction}`);
            }
        });
    }

    // Render devices table with filtering
    function renderDevices() {
        const tbody = document.getElementById('devices-table-body');

        if (devicesData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        No devices found
                    </td>
                </tr>
            `;
            document.getElementById('visible-count').textContent = '0';
            return;
        }

        // Apply filters
        const filteredDevices = devicesData.filter(device => {
            // Filter by offline status
            if (!showOffline && !device.is_online) {
                return false;
            }

            // Filter by text search
            if (filterText) {
                const searchLower = filterText.toLowerCase();
                const matchesName = device.name.toLowerCase().includes(searchLower);
                const matchesIP = device.ip_address.toLowerCase().includes(searchLower);
                const matchesType = device.type.toLowerCase().includes(searchLower);
                const matchesNode = device.node.toLowerCase().includes(searchLower);

                if (!matchesName && !matchesIP && !matchesType && !matchesNode) {
                    return false;
                }
            }

            return true;
        });

        // Update visible count
        document.getElementById('visible-count').textContent = filteredDevices.length;

        if (filteredDevices.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        No devices match the current filters
                    </td>
                </tr>
            `;
            return;
        }

        // Build the device index map for showDeviceDetails
        const deviceIndexMap = new Map();
        devicesData.forEach((device, index) => {
            deviceIndexMap.set(device, index);
        });

        tbody.innerHTML = filteredDevices.map(device => {
            const originalIndex = deviceIndexMap.get(device);
            const rowClass = device.is_online ? '' : 'offline';
            const statusBadge = device.is_online
                ? '<span class="status-badge status-online">Online</span>'
                : '<span class="status-badge status-offline">Offline</span>';

            return `
                <tr class="device-row ${rowClass}" onclick="showDeviceDetails(${originalIndex})">
                    <td>${device.name}</td>
                    <td>${device.type}</td>
                    <td>${device.ip_address}</td>
                    <td>${statusBadge}</td>
                    <td>${device.connection_type}</td>
                    <td>${device.node}</td>
                </tr>
            `;
        }).join('');
    }

    // Modal functions
    function showDeviceDetails(deviceIndex) {
        const device = devicesData[deviceIndex];
        const modal = document.getElementById('device-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');

        // Set title
        modalTitle.textContent = device.name;

        // Build the details HTML
        let detailsHtml = `
            <div class="info-row">
                <div class="info-label">Type:</div>
                <div class="info-value">${device.type}</div>
            </div>
            <div class="info-row">
                <div class="info-label">Status:</div>
                <div class="info-value">${device.is_online ? '<span style="color: var(--green);">● Online</span>' : '<span style="color: var(--subtext0);">● Offline</span>'}</div>
            </div>
            <div class="info-row">
                <div class="info-label">IP Address:</div>
                <div class="info-value">${device.ip_address}</div>
            </div>
            <div class="info-row">
                <div class="info-label">MAC Address:</div>
                <div class="info-value">${device.mac_address}</div>
            </div>
            <div class="info-row">
                <div class="info-label">Connection:</div>
                <div class="info-value">${device.connection_type}</div>
            </div>
            ${device.signal_strength !== null && device.signal_strength !== undefined ? `
            <div class="info-row">
                <div class="info-label">Signal Strength:</div>
                <div class="info-value">${device.signal_strength} dBm</div>
            </div>` : ''}
            ${device.bandwidth_down_mbps !== null && device.bandwidth_down_mbps !== undefined ? `
            <div class="info-row">
                <div class="info-label">Current Download:</div>
                <div class="info-value">${device.bandwidth_down_mbps.toFixed(1)} Mbps</div>
            </div>` : ''}
            ${device.bandwidth_up_mbps !== null && device.bandwidth_up_mbps !== undefined ? `
            <div class="info-row">
                <div class="info-label">Current Upload:</div>
                <div class="info-value">${device.bandwidth_up_mbps.toFixed(1)} Mbps</div>
            </div>` : ''}
            <div class="info-row">
                <div class="info-label">Connected To:</div>
                <div class="info-value">${device.node}</div>
            </div>
            ${device.last_seen ? `
            <div class="info-row">
                <div class="info-label">Last Seen:</div>
                <div class="info-value">${formatTimestamp(device.last_seen)}</div>
            </div>` : ''}
        `;

        // Add bandwidth usage section
        detailsHtml += `
            <div class="bandwidth-section">
                <div class="bandwidth-header">
                    <div class="bandwidth-title">Bandwidth Usage</div>
                    <div class="interval-selector">
                        <button class="interval-btn active" data-days="7" onclick="updateBandwidthDays('${device.mac_address}', 7)">7 Days</button>
                        <button class="interval-btn" data-days="30" onclick="updateBandwidthDays('${device.mac_address}', 30)">30 Days</button>
                    </div>
                </div>
                <div id="device-bandwidth-summary" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1rem; padding: 0 0.25rem;">
                    <div style="text-align: center; padding: 0.5rem; background: var(--surface0); border-radius: 6px;">
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--blue);" id="device-period-download">--</div>
                        <div style="font-size: 0.75rem; color: var(--subtext0);">Download</div>
                    </div>
                    <div style="text-align: center; padding: 0.5rem; background: var(--surface0); border-radius: 6px;">
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--mauve);" id="device-period-upload">--</div>
                        <div style="font-size: 0.75rem; color: var(--subtext0);">Upload</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="bandwidth-chart"></canvas>
                </div>
            </div>
        `;

        // Add aliases section
        const aliasesValue = device.aliases ? device.aliases.join('\n') : '';
        detailsHtml += `
            <div class="aliases-section">
                <div class="aliases-label">DNS Aliases</div>
                <textarea id="aliases-textarea" class="aliases-textarea" placeholder="Enter DNS aliases, one per line">${aliasesValue}</textarea>
                <div class="aliases-help">Each alias will be added as an alternate DNS name for this device</div>
                <button id="save-aliases-btn" class="save-button">Save Aliases</button>
                <div id="save-message" class="save-message"></div>
            </div>
        `;

        modalBody.innerHTML = detailsHtml;

        // Store device MAC for saving
        modalBody.dataset.deviceMac = device.mac_address;

        modal.classList.add('active');

        // Add event listener for save button
        document.getElementById('save-aliases-btn').addEventListener('click', () => saveAliases(device.mac_address));

        // Load bandwidth data
        loadBandwidthChart(device.mac_address, 7);
    }

    function hideModal() {
        const modal = document.getElementById('device-modal');
        modal.classList.remove('active');
    }

    function formatTimestamp(isoString) {
        if (!isoString) return 'N/A';
        const date = new Date(isoString);
        return date.toLocaleString();
    }

    // Save aliases to server
    async function saveAliases(macAddress) {
        const textarea = document.getElementById('aliases-textarea');
        const saveBtn = document.getElementById('save-aliases-btn');
        const saveMessage = document.getElementById('save-message');

        // Get aliases from textarea (one per line)
        const aliasesText = textarea.value;
        const aliases = aliasesText
            .split('\n')
            .map(line => line.trim())
            .filter(line => line.length > 0);

        // Disable button and show loading
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        saveMessage.className = 'save-message';
        saveMessage.textContent = '';

        try {
            const response = await fetch(`/api/devices/${encodeURIComponent(macAddress)}/aliases`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ aliases: aliases }),
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            // Show success message
            saveMessage.className = 'save-message success';
            saveMessage.textContent = `Aliases saved successfully! DNS updated.`;

            // Update the device in our local data
            const deviceIndex = devicesData.findIndex(d => d.mac_address === macAddress);
            if (deviceIndex !== -1) {
                devicesData[deviceIndex].aliases = data.aliases;
            }

            // Hide message after 3 seconds
            setTimeout(() => {
                saveMessage.className = 'save-message';
            }, 3000);

        } catch (error) {
            console.error('Failed to save aliases:', error);
            saveMessage.className = 'save-message error';
            saveMessage.textContent = `Error saving aliases: ${error.message}`;
        } finally {
            // Re-enable button
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Aliases';
        }
    }

    // Bandwidth chart variables
    let bandwidthChart = null;
    let currentDays = 7;

    // Format bytes to human readable format
    function formatBytes(mb) {
        if (mb >= 1000) {
            return `${(mb / 1000).toFixed(2)} GB`;
        }
        return `${mb.toFixed(2)} MB`;
    }

    // Load and render bandwidth chart for device
    async function loadBandwidthChart(macAddress, days) {
        try {
            const response = await fetch(`/api/devices/${encodeURIComponent(macAddress)}/bandwidth-total?days=${days}`);
            const data = await response.json();

            if (!data.daily_breakdown || data.daily_breakdown.length === 0) {
                console.log('No bandwidth data available for device');
                showNoDataMessage();
                return;
            }

            // Update summary
            document.getElementById('device-period-download').textContent = formatBytes(data.totals.download_mb);
            document.getElementById('device-period-upload').textContent = formatBytes(data.totals.upload_mb);

            // Render bar chart
            renderBandwidthChart(data.daily_breakdown);
        } catch (error) {
            console.error('Failed to load bandwidth chart:', error);
            showNoDataMessage();
        }
    }

    function showNoDataMessage() {
        const chartContainer = document.querySelector('.bandwidth-section .chart-container');
        if (chartContainer) {
            chartContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--subtext0);">Bandwidth data is accumulating... Check back soon!</div>';
        }
    }

    // Render bandwidth bar chart
    function renderBandwidthChart(dailyData) {
        const ctx = document.getElementById('bandwidth-chart');
        if (!ctx) return;

        // Destroy existing chart
        if (bandwidthChart) {
            bandwidthChart.destroy();
        }

        const labels = dailyData.map(d => d.date);
        const downloadData = dailyData.map(d => d.download_mb);
        const uploadData = dailyData.map(d => d.upload_mb);

        bandwidthChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Download',
                        data: downloadData,
                        backgroundColor: 'rgba(30, 102, 245, 0.8)', // Catppuccin blue
                        borderColor: 'rgb(30, 102, 245)',
                        borderWidth: 1
                    },
                    {
                        label: 'Upload',
                        data: uploadData,
                        backgroundColor: 'rgba(136, 57, 239, 0.8)', // Catppuccin mauve
                        borderColor: 'rgb(136, 57, 239)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: function(context) {
                                const date = new Date(context[0].label);
                                return date.toLocaleDateString('en-US', {
                                    weekday: 'short',
                                    month: 'short',
                                    day: 'numeric'
                                });
                            },
                            label: function(context) {
                                return `${context.dataset.label}: ${formatBytes(context.parsed.y)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: false,
                        title: {
                            display: true,
                            text: 'Date'
                        },
                        ticks: {
                            callback: function(value, index) {
                                const date = new Date(this.getLabelForValue(value));
                                return date.toLocaleDateString('en-US', {
                                    month: 'short',
                                    day: 'numeric'
                                });
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        stacked: false,
                        title: {
                            display: true,
                            text: 'Data Usage (MB)'
                        },
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000) {
                                    return (value / 1000).toFixed(1) + ' GB';
                                }
                                return value.toFixed(0) + ' MB';
                            }
                        }
                    }
                }
            }
        });
    }

    // Update bandwidth days (called from button onclick)
    function updateBandwidthDays(macAddress, days) {
        currentDays = days;

        // Update button states
        document.querySelectorAll('.interval-btn').forEach(btn => {
            btn.classList.remove('active');
            if (parseInt(btn.dataset.days) === days) {
                btn.classList.add('active');
            }
        });

        // Reload chart with new days
        loadBandwidthChart(macAddress, days);
    }

    // Modal event listeners
    document.getElementById('modal-close').addEventListener('click', hideModal);
    document.getElementById('device-modal').addEventListener('click', (e) => {
        if (e.target.id === 'device-modal') {
            hideModal();
        }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            hideModal();
        }
    });

    // Add click handlers to sortable headers
    document.querySelectorAll('.sortable-header').forEach(header => {
        header.addEventListener('click', () => {
            sortDevices(header.dataset.column);
        });
    });

    // Add filter event listeners
    document.getElementById('filter-input').addEventListener('input', (e) => {
        filterText = e.target.value;
        renderDevices();
    });

    document.getElementById('show-offline-checkbox').addEventListener('change', (e) => {
        showOffline = e.target.checked;
        renderDevices();
    });

    // Initial load
    loadDevices();

    // Refresh every 30 seconds
    setInterval(loadDevices, 30000);
</script>
{% endblock %}
