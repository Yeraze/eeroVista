{% extends "base.html" %}

{% block title %}Settings - eeroVista{% endblock %}

{% block content %}
<h1 class="mt-4 mb-4">Settings</h1>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div class="card-title" style="margin-bottom: 0;">Configuration</div>
        <a href="https://ko-fi.com/yeraze" target="_blank" rel="noopener noreferrer" class="btn" style="background-color: var(--pink); color: var(--base); padding: 0.5rem 1rem; font-size: 0.9rem;">
            <span style="margin-right: 0.5rem;">❤️</span>Support EeroVista
        </a>
    </div>
    <p class="text-muted">Current eeroVista configuration (read-only)</p>

    <table class="table mt-3">
        <tr>
            <th style="width: 40%;">Setting</th>
            <th>Value</th>
        </tr>
        <tr>
            <td>Version</td>
            <td><span class="badge badge-info">{{ settings.version }}</span></td>
        </tr>
        <tr>
            <td>Database Path</td>
            <td><code>{{ settings.database_path }}</code></td>
        </tr>
        <tr>
            <td>Device Collection Interval</td>
            <td>{{ settings.collection_interval_devices }} seconds</td>
        </tr>
        <tr>
            <td>Network Collection Interval</td>
            <td>{{ settings.collection_interval_network }} seconds</td>
        </tr>
        <tr>
            <td>Raw Data Retention</td>
            <td>{{ settings.data_retention_raw_days }} days</td>
        </tr>
        <tr>
            <td>Hourly Data Retention</td>
            <td>{{ settings.data_retention_hourly_days }} days</td>
        </tr>
        <tr>
            <td>Daily Data Retention</td>
            <td>{{ settings.data_retention_daily_days }} days</td>
        </tr>
        <tr>
            <td>Log Level</td>
            <td><span class="badge badge-info">{{ settings.log_level }}</span></td>
        </tr>
    </table>

    <div class="alert alert-info mt-3">
        <strong>Note:</strong> To modify settings, edit environment variables in docker-compose.yml and restart the container.
    </div>
</div>

<div class="card">
    <div class="card-title">Authentication Status</div>
    <table class="table">
        <tr>
            <th style="width: 40%;">Eero Account</th>
            <td><span class="badge badge-success">Authenticated</span></td>
        </tr>
        <tr>
            <th>Session Status</th>
            <td>Active</td>
        </tr>
    </table>
</div>

<div class="card">
    <div class="card-title">System Information</div>
    <table class="table">
        <tr>
            <th style="width: 40%;">Application</th>
            <td>eeroVista</td>
        </tr>
        <tr>
            <th>Mode</th>
            <td><span class="badge badge-info">Read-Only Monitoring</span></td>
        </tr>
        <tr>
            <th>Theme</th>
            <td>Catppuccin Latte</td>
        </tr>
    </table>
</div>

<div class="card">
    <div class="card-title">Database Maintenance</div>
    <p class="text-muted">Clean up data from networks you're no longer authorized for</p>

    <div id="cleanupStatus" class="alert" style="display: none;"></div>

    <button id="cleanupButton" class="btn btn-warning" onclick="cleanupDatabase()">
        <i class="bi bi-trash"></i> Clean Up Unauthorized Networks
    </button>

    <div class="alert alert-info mt-3">
        <strong>What this does:</strong> Removes all devices, nodes, connections, and metrics for networks
        that exist in your database but are not in your current authorized networks list. Useful after
        testing with multiple networks or changing Eero accounts.
    </div>
</div>

<div class="card">
    <div class="card-title">Support & Diagnostics</div>
    <p class="text-muted">Generate a diagnostic package with raw device and node data</p>

    <div id="supportStatus" class="alert" style="display: none;"></div>

    <button id="supportButton" class="btn btn-primary" onclick="generateSupportPackage()">
        <i class="bi bi-download"></i> Generate Support Package
    </button>

    <div class="alert alert-info mt-3">
        <strong>What this does:</strong> Downloads a JSON file containing all raw data from the Eero API
        including network information, eero nodes, connected devices, and profiles. This is useful for
        diagnosing unexpected configurations or reporting issues. The file contains no authentication
        credentials but may include network names and device information.
    </div>
</div>

<script>
async function cleanupDatabase() {
    const button = document.getElementById('cleanupButton');
    const statusDiv = document.getElementById('cleanupStatus');

    // Confirm with user
    if (!confirm('This will permanently delete all data for networks you are no longer authorized for. Continue?')) {
        return;
    }

    // Disable button and show loading state
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Cleaning up...';
    statusDiv.style.display = 'none';

    try {
        const response = await fetch('/api/database/cleanup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.detail || 'Cleanup failed');
        }

        // Show success message
        statusDiv.className = 'alert alert-success';
        statusDiv.style.display = 'block';

        if (data.removed_networks && data.removed_networks.length > 0) {
            let message = `<strong>Success!</strong> Cleaned up ${data.removed_networks.length} network(s): ${data.removed_networks.join(', ')}<br><br>`;
            message += '<strong>Deleted:</strong><ul>';

            for (const [key, count] of Object.entries(data.deleted_counts)) {
                if (count > 0) {
                    message += `<li>${key.replace('_', ' ')}: ${count.toLocaleString()}</li>`;
                }
            }
            message += `</ul><strong>Total records deleted: ${data.total_deleted.toLocaleString()}</strong>`;

            statusDiv.innerHTML = message;
        } else {
            statusDiv.innerHTML = '<strong>No cleanup needed.</strong> ' + data.message;
        }

    } catch (error) {
        // Show error message
        statusDiv.className = 'alert alert-danger';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
    } finally {
        // Re-enable button
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-trash"></i> Clean Up Unauthorized Networks';
    }
}

async function generateSupportPackage() {
    const button = document.getElementById('supportButton');
    const statusDiv = document.getElementById('supportStatus');

    // Disable button and show loading state
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating package...';
    statusDiv.style.display = 'none';

    try {
        const response = await fetch('/api/support/package', {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });

        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.detail || 'Failed to generate support package');
        }

        const data = await response.json();

        // Create a blob from the JSON data
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });

        // Create a download link and trigger it
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `eerovista-support-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        // Show success message
        statusDiv.className = 'alert alert-success';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<strong>Success!</strong> Support package downloaded successfully. The file contains raw data for ' + data.networks.length + ' network(s).';

    } catch (error) {
        // Show error message
        statusDiv.className = 'alert alert-danger';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
    } finally {
        // Re-enable button
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-download"></i> Generate Support Package';
    }
}
</script>
{% endblock %}
