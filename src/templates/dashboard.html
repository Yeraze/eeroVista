{% extends "base.html" %}

{% block title %}Dashboard - eeroVista{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
{% endblock %}

{% block content %}
<h1 class="mt-4 mb-4">Network Dashboard</h1>

<div id="update-banner" style="display: none; background: var(--peach); color: var(--base); padding: 1rem 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
    <div style="font-size: 1.5rem;">⚠️</div>
    <div style="flex: 1;">
        <div style="font-weight: 600; font-size: 1rem;">Firmware Update Available</div>
        <div style="font-size: 0.875rem; margin-top: 0.25rem;">One or more eero nodes have firmware updates available. Visit the <a href="/nodes" style="color: var(--base); text-decoration: underline;">Nodes page</a> for details.</div>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value" id="devices-online">--</div>
        <div class="stat-label">Devices Online</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="devices-total">--</div>
        <div class="stat-label">Total Devices</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="eero-nodes">--</div>
        <div class="stat-label">Eero Nodes</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="network-status">
            <span class="badge badge-success">Connected</span>
        </div>
        <div class="stat-label">Network Status</div>
    </div>
</div>

<div class="card">
    <h2 class="card-title">Network: {{ network_name }}</h2>
    <p class="text-muted">Real-time monitoring and historical data collection</p>

    <div id="collection-status" style="margin-top: 1rem;">
        <p class="text-muted">
            <strong>Last Data Collection:</strong> <span id="last-collection-time">Checking...</span>
        </p>
        <p class="text-muted" style="font-size: 0.85rem;">
            {% if collection_interval_devices < 60 %}
                Device data collected every {{ collection_interval_devices }} seconds
            {% elif collection_interval_devices == 60 %}
                Device data collected every minute
            {% else %}
                Device data collected every {{ collection_interval_devices // 60 }} minutes
            {% endif %}
        </p>
    </div>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 class="card-title" style="margin: 0;">Bandwidth Usage</h2>
        <div style="display: flex; gap: 0.5rem;">
            <button class="interval-btn" data-mode="hourly" onclick="updateNetworkBandwidthMode('hourly')">Hourly</button>
            <button class="interval-btn active" data-days="7" onclick="updateNetworkBandwidthDays(7)">7 Days</button>
            <button class="interval-btn" data-days="30" onclick="updateNetworkBandwidthDays(30)">30 Days</button>
        </div>
    </div>
    <div id="bandwidth-summary" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
        <div style="text-align: center; padding: 0.75rem; background: var(--surface0); border-radius: 8px;">
            <div style="font-size: 1.5rem; font-weight: 600; color: var(--blue);" id="today-download">--</div>
            <div style="font-size: 0.875rem; color: var(--subtext0);">Today Download</div>
        </div>
        <div style="text-align: center; padding: 0.75rem; background: var(--surface0); border-radius: 8px;">
            <div style="font-size: 1.5rem; font-weight: 600; color: var(--mauve);" id="today-upload">--</div>
            <div style="font-size: 0.875rem; color: var(--subtext0);">Today Upload</div>
        </div>
        <div style="text-align: center; padding: 0.75rem; background: var(--surface0); border-radius: 8px;">
            <div style="font-size: 1.5rem; font-weight: 600; color: var(--text);" id="period-total">--</div>
            <div style="font-size: 0.875rem; color: var(--subtext0);" id="period-label">7 Day Total</div>
        </div>
    </div>
    <div style="height: 300px; position: relative;">
        <canvas id="network-bandwidth-chart"></canvas>
    </div>
</div>

<style>
    .interval-btn {
        padding: 0.25rem 0.75rem;
        background-color: var(--surface0);
        color: var(--text);
        border: 1px solid var(--surface1);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .interval-btn.active {
        background-color: var(--blue);
        color: white;
        border-color: var(--blue);
    }

    .interval-btn:hover:not(.active) {
        background-color: var(--surface1);
    }
</style>

<script>
    // Fetch dashboard statistics
    async function updateDashboardStats() {
        try {
            const response = await fetch('/api/dashboard-stats');
            const data = await response.json();

            // Update stat cards
            document.getElementById('devices-online').textContent = data.devices_online || 0;
            document.getElementById('devices-total').textContent = data.devices_total || 0;
            document.getElementById('eero-nodes').textContent = data.eero_nodes || 0;

            // Update network status badge
            const statusElement = document.getElementById('network-status');
            const statusClass = data.wan_status === 'online' ? 'badge-success' :
                               data.wan_status === 'offline' ? 'badge-danger' : 'badge-warning';
            const statusText = data.wan_status || 'Unknown';
            statusElement.innerHTML = `<span class="badge ${statusClass}">${statusText}</span>`;

            // Show/hide update banner
            const updateBanner = document.getElementById('update-banner');
            if (data.updates_available) {
                updateBanner.style.display = 'flex';
            } else {
                updateBanner.style.display = 'none';
            }

        } catch (error) {
            console.error('Failed to fetch dashboard stats:', error);
        }
    }

    // Fetch collection status
    async function updateCollectionStatus() {
        try {
            const response = await fetch('/api/collection-status');
            const data = await response.json();

            if (data.collections) {
                const deviceCollection = data.collections.device;

                if (deviceCollection && deviceCollection.timestamp) {
                    const secondsAgo = deviceCollection.seconds_ago;
                    const timeAgo = formatTimeAgo(secondsAgo);
                    const statusElement = document.getElementById('last-collection-time');

                    if (secondsAgo < 360) {  // Less than 6 minutes
                        statusElement.innerHTML = `<span style="color: var(--green);">${timeAgo}</span>`;
                    } else if (secondsAgo < 900) {  // Less than 15 minutes
                        statusElement.innerHTML = `<span style="color: var(--yellow);">${timeAgo}</span>`;
                    } else {
                        statusElement.innerHTML = `<span style="color: var(--red);">${timeAgo}</span>`;
                    }
                } else {
                    document.getElementById('last-collection-time').textContent = 'No data collected yet';
                }
            }
        } catch (error) {
            console.error('Failed to fetch collection status:', error);
            document.getElementById('last-collection-time').textContent = 'Error fetching status';
        }
    }

    function formatTimeAgo(seconds) {
        if (seconds < 60) {
            return `${seconds} seconds ago`;
        } else if (seconds < 3600) {
            const minutes = Math.floor(seconds / 60);
            return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        } else {
            const hours = Math.floor(seconds / 3600);
            return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        }
    }

    // Network bandwidth chart variables
    let networkBandwidthChart = null;
    let currentDays = 7;
    let currentMode = 'daily';  // 'hourly' or 'daily'

    // Format bytes to human readable format
    function formatBytes(mb) {
        if (mb >= 1000) {
            return `${(mb / 1000).toFixed(2)} GB`;
        }
        return `${mb.toFixed(2)} MB`;
    }

    // Load and render network bandwidth chart
    async function loadNetworkBandwidthChart(days) {
        try {
            const response = await fetch(`/api/network/bandwidth-total?days=${days}`);
            const data = await response.json();

            if (!data.daily_breakdown || data.daily_breakdown.length === 0) {
                console.log('No network bandwidth data available');
                showNetworkNoDataMessage();
                return;
            }

            // Update summary stats
            updateBandwidthSummary(data, days, 'daily');

            // Render bar chart
            renderNetworkBandwidthChart(data.daily_breakdown, 'daily');
        } catch (error) {
            console.error('Failed to load network bandwidth chart:', error);
            showNetworkNoDataMessage();
        }
    }

    // Load and render hourly bandwidth chart
    async function loadNetworkBandwidthHourlyChart() {
        try {
            const response = await fetch('/api/network/bandwidth-hourly');
            const data = await response.json();

            if (!data.hourly_breakdown || data.hourly_breakdown.length === 0) {
                console.log('No hourly bandwidth data available');
                showNetworkNoDataMessage();
                return;
            }

            // Update summary stats
            updateBandwidthSummary(data, null, 'hourly');

            // Render bar chart
            renderNetworkBandwidthChart(data.hourly_breakdown, 'hourly');
        } catch (error) {
            console.error('Failed to load hourly bandwidth chart:', error);
            showNetworkNoDataMessage();
        }
    }

    function updateBandwidthSummary(data, days, mode) {
        if (mode === 'hourly') {
            // For hourly view, show today's totals
            document.getElementById('today-download').textContent = formatBytes(data.totals.download_mb);
            document.getElementById('today-upload').textContent = formatBytes(data.totals.upload_mb);
            document.getElementById('period-total').textContent = formatBytes(data.totals.total_mb);
            document.getElementById('period-label').textContent = 'Today Total';
        } else {
            // Get today's data (last entry in breakdown)
            const todayData = data.daily_breakdown[data.daily_breakdown.length - 1];

            if (todayData) {
                document.getElementById('today-download').textContent = formatBytes(todayData.download_mb);
                document.getElementById('today-upload').textContent = formatBytes(todayData.upload_mb);
            }

            // Show period total
            document.getElementById('period-total').textContent = formatBytes(data.totals.total_mb);
            document.getElementById('period-label').textContent = days === 7 ? '7 Day Total' : '30 Day Total';
        }
    }

    function showNetworkNoDataMessage() {
        const ctx = document.getElementById('network-bandwidth-chart');
        if (ctx) {
            // Destroy existing chart if present
            if (networkBandwidthChart) {
                networkBandwidthChart.destroy();
                networkBandwidthChart = null;
            }
            // Replace canvas with message
            const container = ctx.parentElement;
            container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--subtext0); font-size: 1rem;">Bandwidth data is accumulating... Check back soon!</div>';
        }
    }

    // Render network bandwidth bar chart
    function renderNetworkBandwidthChart(data, mode) {
        const ctx = document.getElementById('network-bandwidth-chart');
        if (!ctx) return;

        // Destroy existing chart
        if (networkBandwidthChart) {
            networkBandwidthChart.destroy();
        }

        let labels, downloadData, uploadData, xAxisTitle, tooltipTitleFormatter, tickFormatter;

        if (mode === 'hourly') {
            // Hourly mode
            labels = data.map(d => d.hour_label);
            downloadData = data.map(d => d.download_mb);
            uploadData = data.map(d => d.upload_mb);
            xAxisTitle = 'Hour';

            tooltipTitleFormatter = function(context) {
                return context[0].label;
            };

            tickFormatter = function(value, index) {
                return this.getLabelForValue(value);
            };
        } else {
            // Daily mode
            labels = data.map(d => d.date);
            downloadData = data.map(d => d.download_mb);
            uploadData = data.map(d => d.upload_mb);
            xAxisTitle = 'Date';

            tooltipTitleFormatter = function(context) {
                const date = new Date(context[0].label);
                return date.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
            };

            tickFormatter = function(value, index) {
                const date = new Date(this.getLabelForValue(value));
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });
            };
        }

        networkBandwidthChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Download',
                        data: downloadData,
                        backgroundColor: 'rgba(30, 102, 245, 0.8)', // Catppuccin blue
                        borderColor: 'rgb(30, 102, 245)',
                        borderWidth: 1
                    },
                    {
                        label: 'Upload',
                        data: uploadData,
                        backgroundColor: 'rgba(136, 57, 239, 0.8)', // Catppuccin mauve
                        borderColor: 'rgb(136, 57, 239)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: tooltipTitleFormatter,
                            label: function(context) {
                                return `${context.dataset.label}: ${formatBytes(context.parsed.y)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: false,
                        title: {
                            display: true,
                            text: xAxisTitle
                        },
                        ticks: {
                            callback: tickFormatter
                        }
                    },
                    y: {
                        beginAtZero: true,
                        stacked: false,
                        title: {
                            display: true,
                            text: 'Data Usage (MB)'
                        },
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000) {
                                    return (value / 1000).toFixed(1) + ' GB';
                                }
                                return value.toFixed(0) + ' MB';
                            }
                        }
                    }
                }
            }
        });
    }

    // Update network bandwidth mode (hourly or daily)
    function updateNetworkBandwidthMode(mode) {
        currentMode = mode;

        // Update button states
        document.querySelectorAll('.interval-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.mode === mode) {
                btn.classList.add('active');
            }
        });

        // Load hourly chart
        loadNetworkBandwidthHourlyChart();
    }

    // Update network bandwidth days (called from button onclick)
    function updateNetworkBandwidthDays(days) {
        currentDays = days;
        currentMode = 'daily';

        // Update button states
        document.querySelectorAll('.interval-btn').forEach(btn => {
            btn.classList.remove('active');
            if (parseInt(btn.dataset.days) === days) {
                btn.classList.add('active');
            }
        });

        // Reload chart with new days
        loadNetworkBandwidthChart(days);
    }

    // Update all data
    function updateAll() {
        updateDashboardStats();
        updateCollectionStatus();

        // Load appropriate chart based on current mode
        if (currentMode === 'hourly') {
            loadNetworkBandwidthHourlyChart();
        } else {
            loadNetworkBandwidthChart(currentDays);
        }
    }

    // Initial load
    updateAll();

    // Update every 30 seconds
    setInterval(updateAll, 30000);
</script>
{% endblock %}
