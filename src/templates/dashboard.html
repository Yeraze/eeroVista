{% extends "base.html" %}

{% block title %}Dashboard - eeroVista{% endblock %}

{% block content %}
<h1 class="mt-4 mb-4">Network Dashboard</h1>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value" id="devices-online">--</div>
        <div class="stat-label">Devices Online</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="devices-total">--</div>
        <div class="stat-label">Total Devices</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="eero-nodes">--</div>
        <div class="stat-label">Eero Nodes</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="network-status">
            <span class="badge badge-success">Connected</span>
        </div>
        <div class="stat-label">Network Status</div>
    </div>
</div>

<div class="card">
    <h2 class="card-title">Network: {{ network_name }}</h2>
    <p class="text-muted">Real-time monitoring and historical data collection</p>

    <div id="collection-status" style="margin-top: 1rem;">
        <p class="text-muted">
            <strong>Last Data Collection:</strong> <span id="last-collection-time">Checking...</span>
        </p>
        <p class="text-muted" style="font-size: 0.85rem;">
            Data collectors run every 5 minutes
        </p>
    </div>
</div>

<div class="card">
    <h2 class="card-title">Quick Stats</h2>
    <div style="height: 300px; display: flex; align-items: center; justify-content: center;">
        <p class="text-muted">Charts and graphs will appear here once data collection begins</p>
    </div>
</div>

<script>
    // Fetch dashboard statistics
    async function updateDashboardStats() {
        try {
            const response = await fetch('/api/dashboard-stats');
            const data = await response.json();

            // Update stat cards
            document.getElementById('devices-online').textContent = data.devices_online || 0;
            document.getElementById('devices-total').textContent = data.devices_total || 0;
            document.getElementById('eero-nodes').textContent = data.eero_nodes || 0;

            // Update network status badge
            const statusElement = document.getElementById('network-status');
            const statusClass = data.wan_status === 'online' ? 'badge-success' :
                               data.wan_status === 'offline' ? 'badge-danger' : 'badge-warning';
            const statusText = data.wan_status || 'Unknown';
            statusElement.innerHTML = `<span class="badge ${statusClass}">${statusText}</span>`;

        } catch (error) {
            console.error('Failed to fetch dashboard stats:', error);
        }
    }

    // Fetch collection status
    async function updateCollectionStatus() {
        try {
            const response = await fetch('/api/collection-status');
            const data = await response.json();

            if (data.collections) {
                const deviceCollection = data.collections.device;

                if (deviceCollection && deviceCollection.timestamp) {
                    const secondsAgo = deviceCollection.seconds_ago;
                    const timeAgo = formatTimeAgo(secondsAgo);
                    const statusElement = document.getElementById('last-collection-time');

                    if (secondsAgo < 360) {  // Less than 6 minutes
                        statusElement.innerHTML = `<span style="color: var(--green);">${timeAgo}</span>`;
                    } else if (secondsAgo < 900) {  // Less than 15 minutes
                        statusElement.innerHTML = `<span style="color: var(--yellow);">${timeAgo}</span>`;
                    } else {
                        statusElement.innerHTML = `<span style="color: var(--red);">${timeAgo}</span>`;
                    }
                } else {
                    document.getElementById('last-collection-time').textContent = 'No data collected yet';
                }
            }
        } catch (error) {
            console.error('Failed to fetch collection status:', error);
            document.getElementById('last-collection-time').textContent = 'Error fetching status';
        }
    }

    function formatTimeAgo(seconds) {
        if (seconds < 60) {
            return `${seconds} seconds ago`;
        } else if (seconds < 3600) {
            const minutes = Math.floor(seconds / 60);
            return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        } else {
            const hours = Math.floor(seconds / 3600);
            return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        }
    }

    // Update all data
    function updateAll() {
        updateDashboardStats();
        updateCollectionStatus();
    }

    // Initial load
    updateAll();

    // Update every 30 seconds
    setInterval(updateAll, 30000);
</script>
{% endblock %}
